<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <title>Lumina Dental ‚Äî –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å</title>
    <meta name="robots" content="noindex,nofollow">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap"
        rel="stylesheet">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%230B1421'/><text x='16' y='23' font-size='18' text-anchor='middle' fill='%234EA8DE'>‚ú¶</text></svg>"
        type="image/svg+xml">
    <style>
        :root {
            --bg: #0B0F14;
            --bg2: #111820;
            --srf: #1A2230;
            --txt: #F0F2F5;
            --muted: #8A94A6;
            --blue: #4EA8DE;
            --cta: #E8915A;
            --cta2: #F0A46E;
            --ok: #34D399;
            --err: #F87171;
            --brd: rgba(255, 255, 255, .04);
            --ibrd: rgba(255, 255, 255, .08);
            --r-s: 8px;
            --r-m: 12px;
            --r-l: 16px;
            --r-xl: 24px;
            --foc: 0 0 0 3px rgba(78, 168, 222, .25);
            --ease: cubic-bezier(.25, .46, .45, .94);
            --dur: 240ms;
            --font: 'Manrope', system-ui, sans-serif;
            --side: 240px;
            --top: 60px
        }

        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box
        }

        html {
            -webkit-text-size-adjust: 100%
        }

        body {
            font-family: var(--font);
            font-size: .9375rem;
            line-height: 1.6;
            color: var(--txt);
            background: var(--bg);
            -webkit-font-smoothing: antialiased
        }

        a {
            color: var(--blue);
            text-decoration: none
        }

        a:hover {
            text-decoration: underline
        }

        ul {
            list-style: none
        }

        button,
        input,
        select,
        textarea {
            font: inherit;
            color: inherit
        }

        img {
            max-width: 100%;
            display: block
        }

        /* LOGIN */
        .login-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100dvh;
            padding: 20px
        }

        .login-card {
            background: var(--srf);
            border: 1px solid var(--brd);
            border-radius: var(--r-xl);
            padding: 40px 32px;
            max-width: 420px;
            width: 100%;
            text-align: center
        }

        .login-card__logo {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px
        }

        .login-card__logo span {
            color: var(--blue);
            font-weight: 400
        }

        .login-card__sub {
            color: var(--muted);
            font-size: .8125rem;
            margin-bottom: 28px
        }

        .login-card__fields {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 16px
        }

        .login-card__error {
            font-size: .8125rem;
            color: var(--err);
            min-height: 20px;
            margin-bottom: 8px
        }

        @keyframes shake {

            0%,
            100% {
                transform: translateX(0)
            }

            20%,
            60% {
                transform: translateX(-6px)
            }

            40%,
            80% {
                transform: translateX(6px)
            }
        }

        .shake {
            animation: shake .4s ease
        }

        /* INPUTS */
        .input {
            display: block;
            width: 100%;
            padding: 12px 16px;
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--ibrd);
            border-radius: var(--r-m);
            color: var(--txt);
            font-size: .9375rem;
            outline: none;
            transition: border-color var(--dur) var(--ease), box-shadow var(--dur) var(--ease)
        }

        .input:focus {
            border-color: var(--blue);
            box-shadow: var(--foc)
        }

        .input--error {
            border-color: var(--err) !important;
            box-shadow: 0 0 0 3px rgba(248, 113, 113, .2) !important
        }

        .input::placeholder {
            color: var(--muted);
            opacity: .6
        }

        textarea.input {
            resize: vertical;
            min-height: 80px
        }

        select.input {
            cursor: pointer;
            appearance: auto
        }

        /* BUTTONS */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 20px;
            font-weight: 600;
            font-size: .8125rem;
            border-radius: 10px;
            border: 1px solid transparent;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--dur) var(--ease);
            background: none
        }

        .btn:disabled {
            opacity: .45;
            cursor: not-allowed
        }

        .btn--primary {
            background: var(--cta);
            color: var(--bg);
            border-color: var(--cta)
        }

        .btn--primary:hover:not(:disabled) {
            background: var(--cta2)
        }

        .btn--outline {
            border-color: var(--ibrd);
            color: var(--muted)
        }

        .btn--outline:hover:not(:disabled) {
            border-color: var(--blue);
            color: var(--txt)
        }

        .btn--danger {
            border-color: rgba(248, 113, 113, .3);
            color: var(--err)
        }

        .btn--danger:hover:not(:disabled) {
            background: rgba(248, 113, 113, .1)
        }

        .btn--sm {
            padding: 6px 12px;
            font-size: .75rem;
            border-radius: 8px
        }

        .btn--full {
            width: 100%
        }

        .btn--icon {
            width: 32px;
            height: 32px;
            padding: 0;
            border-radius: 8px;
            font-size: 1rem
        }

        /* LAYOUT */
        .admin {
            display: none
        }

        .admin.is-active {
            display: flex;
            min-height: 100dvh
        }

        .topbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--top);
            background: rgba(11, 15, 20, .92);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--brd);
            z-index: 100;
            display: flex;
            align-items: center;
            padding: 0 20px;
            gap: 12px
        }

        .topbar__brand {
            font-weight: 700;
            font-size: 1rem;
            margin-right: auto;
            white-space: nowrap
        }

        .topbar__brand span {
            color: var(--blue);
            font-weight: 400
        }

        .topbar__status {
            font-size: .75rem;
            font-weight: 600;
            padding: 4px 12px;
            border-radius: 999px
        }

        .topbar__status--unsaved {
            background: rgba(248, 113, 113, .12);
            color: var(--err)
        }

        .topbar__status--saved {
            background: rgba(52, 211, 153, .12);
            color: var(--ok)
        }

        .topbar__actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap
        }

        .sidebar {
            position: fixed;
            top: var(--top);
            left: 0;
            bottom: 0;
            width: var(--side);
            background: var(--bg2);
            border-right: 1px solid var(--brd);
            z-index: 90;
            overflow-y: auto;
            padding: 16px 0;
            display: none
        }

        .sidebar__link {
            display: block;
            padding: 10px 24px;
            font-size: .8125rem;
            font-weight: 500;
            color: var(--muted);
            transition: all var(--dur) var(--ease);
            border-left: 3px solid transparent;
            cursor: pointer
        }

        .sidebar__link:hover,
        .sidebar__link.is-active {
            color: var(--txt);
            background: rgba(255, 255, 255, .03);
            text-decoration: none
        }

        .sidebar__link.is-active {
            border-left-color: var(--cta)
        }

        .mobile-tabs {
            position: fixed;
            top: var(--top);
            left: 0;
            right: 0;
            z-index: 90;
            background: var(--bg2);
            border-bottom: 1px solid var(--brd);
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            padding: 0 12px
        }

        .mobile-tabs::-webkit-scrollbar {
            display: none
        }

        .mobile-tabs__btn {
            padding: 10px 16px;
            font-size: .75rem;
            font-weight: 600;
            color: var(--muted);
            white-space: nowrap;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: all var(--dur) var(--ease)
        }

        .mobile-tabs__btn:hover,
        .mobile-tabs__btn.is-active {
            color: var(--txt)
        }

        .mobile-tabs__btn.is-active {
            border-bottom-color: var(--cta)
        }

        .admin-main {
            flex: 1;
            margin-top: calc(var(--top) + 44px);
            padding: 24px 16px 80px;
            width: 100%
        }

        .admin-section {
            display: none;
            max-width: 900px;
            margin: 0 auto
        }

        .admin-section.is-active {
            display: block
        }

        .admin-section__title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 4px
        }

        .admin-section__helper {
            font-size: .8125rem;
            color: var(--muted);
            margin-bottom: 24px
        }

        .card {
            background: var(--srf);
            border: 1px solid var(--brd);
            border-radius: var(--r-xl);
            padding: 24px;
            margin-bottom: 20px
        }

        .field {
            margin-bottom: 16px
        }

        .field__label {
            display: block;
            font-size: .75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: .04em;
            color: var(--muted);
            margin-bottom: 6px
        }

        .field__error {
            font-size: .75rem;
            color: var(--err);
            margin-top: 4px
        }

        .field__hint {
            font-size: .6875rem;
            color: var(--muted);
            opacity: .6;
            margin-top: 4px
        }

        .img-preview-row {
            display: flex;
            gap: 8px;
            align-items: flex-start;
            flex-wrap: wrap
        }

        .img-preview-row .input {
            flex: 1;
            min-width: 200px
        }

        .img-preview {
            width: 80px;
            height: 60px;
            border-radius: var(--r-s);
            background: var(--bg2);
            object-fit: cover;
            border: 1px solid var(--brd);
            flex-shrink: 0
        }

        /* === Upload button styles === */
        .img-upload-btn {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: 1px solid var(--blue);
            border-radius: var(--r-s);
            background: transparent;
            color: var(--blue);
            font-size: .75rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all var(--dur) var(--ease);
            flex-shrink: 0
        }

        .img-upload-btn:hover {
            background: rgba(78, 168, 222, .1)
        }

        .img-upload-btn:disabled {
            opacity: .5;
            cursor: not-allowed
        }

        .img-upload-status {
            font-size: .7rem;
            margin-top: 4px;
            min-height: 1em
        }

        .img-upload-status--ok {
            color: var(--ok)
        }

        .img-upload-status--err {
            color: var(--err)
        }

        .img-upload-status--loading {
            color: var(--muted)
        }

        .array-item {
            border: 1px solid var(--brd);
            border-radius: var(--r-l);
            padding: 16px;
            margin-bottom: 12px;
            background: rgba(255, 255, 255, .01);
            position: relative
        }

        .array-item__header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-size: .8125rem;
            font-weight: 600;
            color: var(--muted)
        }

        .array-item__actions {
            margin-left: auto;
            display: flex;
            gap: 4px
        }

        .array-add {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            padding: 12px;
            border: 2px dashed var(--ibrd);
            border-radius: var(--r-l);
            background: transparent;
            color: var(--muted);
            font-size: .8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--dur) var(--ease)
        }

        .array-add:hover {
            border-color: var(--blue);
            color: var(--blue)
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            border-radius: var(--r-m);
            font-size: .875rem;
            font-weight: 600;
            z-index: 9999;
            transform: translateY(100px);
            opacity: 0;
            transition: all 300ms var(--ease);
            pointer-events: none;
            max-width: 360px
        }

        .toast.is-visible {
            transform: translateY(0);
            opacity: 1
        }

        .toast--success {
            background: rgba(52, 211, 153, .15);
            color: var(--ok);
            border: 1px solid rgba(52, 211, 153, .25)
        }

        .toast--error {
            background: rgba(248, 113, 113, .15);
            color: var(--err);
            border: 1px solid rgba(248, 113, 113, .25)
        }

        .toast--info {
            background: rgba(78, 168, 222, .15);
            color: var(--blue);
            border: 1px solid rgba(78, 168, 222, .25)
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            font-size: .875rem
        }

        .checkbox-row input[type=checkbox] {
            width: 18px;
            height: 18px;
            accent-color: var(--blue)
        }

        @media(min-width:1024px) {
            .sidebar {
                display: block
            }

            .mobile-tabs {
                display: none
            }

            .admin-main {
                margin-left: var(--side);
                margin-top: var(--top);
                padding: 32px 40px 80px
            }
        }
    </style>
</head>

<body>

    <!-- LOGIN -->
    <div class="login-screen" id="login-screen">
        <div class="login-card" id="login-card">
            <div class="login-card__logo">‚ú¶ Lumina <span>Dental</span></div>
            <p class="login-card__sub">–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∞–π—Ç–æ–º</p>
            <div class="login-card__fields">
                <input type="email" class="input" id="login-email" placeholder="E-mail" autocomplete="email">
                <input type="password" class="input" id="login-pass" placeholder="–ü–∞—Ä–æ–ª—å"
                    autocomplete="current-password">
            </div>
            <div class="login-card__error" id="login-error"></div>
            <button class="btn btn--primary btn--full" id="login-btn">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <!-- ADMIN -->
    <div class="admin" id="admin-panel">
        <div class="topbar">
            <div class="topbar__brand">‚ú¶ Lumina <span>Dental</span> ¬∑ CMS</div>
            <span class="topbar__status topbar__status--saved" id="save-status">–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ</span>
            <div class="topbar__actions">
                <button class="btn btn--primary btn--sm" id="btn-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn btn--outline btn--sm" id="btn-export">üì¶ –≠–∫—Å–ø–æ—Ä—Ç</button>
                <button class="btn btn--outline btn--sm" id="btn-preview">üëÅ –ü—Ä–µ–≤—å—é</button>
                <button class="btn btn--danger btn--sm" id="btn-reset">‚Ü∫ –°–±—Ä–æ—Å</button>
                <button class="btn btn--outline btn--sm" id="btn-logout">–í—ã–π—Ç–∏</button>
            </div>
        </div>
        <div class="mobile-tabs" id="mobile-tabs"></div>
        <nav class="sidebar" id="sidebar"></nav>
        <main class="admin-main" id="admin-main"></main>
    </div>

    <div class="toast" id="toast"></div>

    <script src="data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        (function () {
            "use strict";

            const SUPA_URL = "https://euaobzhnsempmwantvnt.supabase.co";
            const SUPA_KEY = "sb_publishable_z8zBPuW3R2fF7gcoi_c5uw_cnnWU2zM";
            const supa = window.supabase.createClient(SUPA_URL, SUPA_KEY);
            const LS_KEY = "siteData_lumina", LS_UPD = "siteData_lumina_updated";

            const $ = s => document.querySelector(s);
            const $$ = s => [...document.querySelectorAll(s)];
            function deepClone(o) { return JSON.parse(JSON.stringify(o)) }

            let DATA = {};
            let toastT = null;
            function toast(msg, type = "success") { const el = $("#toast"); el.textContent = msg; el.className = `toast toast--${type}`; requestAnimationFrame(() => el.classList.add("is-visible")); clearTimeout(toastT); toastT = setTimeout(() => el.classList.remove("is-visible"), 3000) }
            function setStatus(saved) { const el = $("#save-status"); el.textContent = saved ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ" : "–ù–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ"; el.className = "topbar__status topbar__status--" + (saved ? "saved" : "unsaved") }
            function markDirty() { setStatus(false) }

            /* SECTIONS CONFIG */
            const SECTIONS = [
                { id: "brand", label: "–ë—Ä–µ–Ω–¥ –∏ Hero", render: renderBrand },
                { id: "trust", label: "–î–æ–≤–µ—Ä–∏–µ", render: renderTrust },
                { id: "why", label: "–ü–æ—á–µ–º—É –º—ã", render: renderWhySection },
                { id: "services", label: "–£—Å–ª—É–≥–∏", render: renderServicesSection },
                { id: "cases", label: "–ö–µ–π—Å—ã", render: renderCasesSection },
                { id: "doctors", label: "–í—Ä–∞—á–∏", render: renderDoctorsSection },
                { id: "testimonials", label: "–û—Ç–∑—ã–≤—ã", render: renderTestimonialsSection },
                { id: "prices", label: "–¶–µ–Ω—ã", render: renderPricesSection },
                { id: "quiz", label: "–ö–≤–∏–∑", render: renderQuizSection },
                { id: "contacts", label: "–ö–æ–Ω—Ç–∞–∫—Ç—ã", render: renderContactsSection }
            ];

            /* AUTH */
            async function initAuth() {
                const { data: { session } } = await supa.auth.getSession();
                if (session) { showAdmin(); return }
                $("#login-screen").style.display = "flex";
                $("#login-btn").onclick = async () => {
                    const email = $("#login-email").value.trim();
                    const pass = $("#login-pass").value;
                    const errEl = $("#login-error");
                    if (!email || !pass) { errEl.textContent = "–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å"; return }
                    $("#login-btn").disabled = true; $("#login-btn").textContent = "–í—Ö–æ–¥...";
                    const { error } = await supa.auth.signInWithPassword({ email, password: pass });
                    if (error) { errEl.textContent = error.message; $("#login-card").classList.remove("shake"); void $("#login-card").offsetWidth; $("#login-card").classList.add("shake"); $("#login-btn").disabled = false; $("#login-btn").textContent = "–í–æ–π—Ç–∏"; return }
                    showAdmin();
                };
                $("#login-pass").addEventListener("keydown", e => { if (e.key === "Enter") $("#login-btn").click() });
                $("#login-email").addEventListener("keydown", e => { if (e.key === "Enter") $("#login-pass").focus() });
            }

            // === FIX v2: data.js is loaded synchronously (no defer/async),
            //     so DEFAULT_SITE_DATA is GUARANTEED to exist here.
            //     No polling needed. If it's missing ‚Äî data.js has a syntax error or 404. ===
            async function showAdmin() {
                console.log("[ADMIN] showAdmin() called");
                $("#login-screen").style.display = "none";
                $("#admin-panel").classList.add("is-active");

                // --- Debug: verify data.js loaded ---
                if (typeof DEFAULT_SITE_DATA === "undefined") {
                    console.error("[ADMIN] FATAL: DEFAULT_SITE_DATA is undefined. data.js did not load or has a syntax error. Check Network tab for 404 on data.js.");
                } else {
                    console.log("[ADMIN] DEFAULT_SITE_DATA OK, keys:", Object.keys(DEFAULT_SITE_DATA).length);
                }

                await loadData();
                console.log("[ADMIN] DATA loaded, keys:", Object.keys(DATA));
                buildNav();
                buildSections();
                switchSection(SECTIONS[0].id);
                initActions();
                console.log("[ADMIN] Admin panel fully initialized");
            }

            async function loadData() {
                // Always start from DEFAULT_SITE_DATA as the base (never empty object)
                const base = (typeof DEFAULT_SITE_DATA !== "undefined" && Object.keys(DEFAULT_SITE_DATA).length > 0)
                    ? deepClone(DEFAULT_SITE_DATA)
                    : { brand: "", nav: [], heroTitle: "", heroSubtitle: "", heroBullets: [], heroImage: "", trustBadges: [], why: [], services: [], cases: [], doctors: [], testimonials: [], prices: [], quiz: { steps: [], finalBonusText: "" }, contacts: {} };

                // 1. Try Supabase cloud
                try {
                    const { data, error } = await supa.from("site_settings").select("data").eq("id", "lumina").single();
                    if (!error && data && data.data && Object.keys(data.data).length > 0) {
                        DATA = Object.assign({}, base, data.data);
                        console.log("[ADMIN] Data loaded from Supabase (" + Object.keys(data.data).length + " keys)");
                        toast("–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞", "info");
                        return;
                    }
                    console.log("[ADMIN] Supabase returned no data (error:", error?.message || "empty result", ")");
                } catch (e) { console.warn("[ADMIN] Supabase load error:", e.message) }

                // 2. Try localStorage (but validate it's not garbage)
                try {
                    const ls = localStorage.getItem(LS_KEY);
                    if (ls) {
                        const parsed = JSON.parse(ls);
                        if (parsed && typeof parsed === "object" && Object.keys(parsed).length > 5) {
                            DATA = Object.assign({}, base, parsed);
                            console.log("[ADMIN] Data loaded from localStorage (" + Object.keys(parsed).length + " keys)");
                            toast("–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ", "info");
                            return;
                        }
                        console.warn("[ADMIN] localStorage data looks incomplete (" + Object.keys(parsed).length + " keys), ignoring");
                    }
                } catch (e) { console.warn("[ADMIN] localStorage parse error:", e.message) }

                // 3. Use DEFAULT_SITE_DATA as-is
                DATA = base;
                console.log("[ADMIN] Using DEFAULT_SITE_DATA as base (" + Object.keys(DATA).length + " keys)");
                toast("–ó–∞–≥—Ä—É–∂–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é", "info");
            }

            function buildNav() {
                const sb = $("#sidebar"), mt = $("#mobile-tabs");
                sb.innerHTML = SECTIONS.map(s => `<a class="sidebar__link" data-sec="${s.id}">${s.label}</a>`).join("");
                mt.innerHTML = SECTIONS.map(s => `<button class="mobile-tabs__btn" data-sec="${s.id}">${s.label}</button>`).join("");
                sb.addEventListener("click", e => { const l = e.target.closest("[data-sec]"); if (l) switchSection(l.dataset.sec) });
                mt.addEventListener("click", e => { const l = e.target.closest("[data-sec]"); if (l) switchSection(l.dataset.sec) });
            }

            function buildSections() {
                const main = $("#admin-main");
                main.innerHTML = SECTIONS.map(s => `<div class="admin-section" id="sec-${s.id}"></div>`).join("");
                // === FIX: try/catch each section so one crash doesn't kill the rest ===
                SECTIONS.forEach(s => {
                    try {
                        s.render();
                    } catch (err) {
                        console.warn(`[ADMIN FIX] Section "${s.id}" render failed:`, err.message);
                        const el = $(`#sec-${s.id}`);
                        if (el) el.innerHTML = `<h2 class="admin-section__title">${s.label}</h2><p class="admin-section__helper" style="color:#f87171">‚ö† –û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∞: ${err.message}. –î–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–≥–æ —Ä–∞–∑–¥–µ–ª–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –∏–ª–∏ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω—ã.</p>`;
                    }
                });
            }

            function switchSection(id) {
                $$(".admin-section").forEach(s => s.classList.remove("is-active"));
                $$(".sidebar__link,.mobile-tabs__btn").forEach(l => { l.classList.toggle("is-active", l.dataset.sec === id) });
                const sec = $(`#sec-${id}`); if (sec) sec.classList.add("is-active");
            }

            /* FIELD HELPERS */
            function fieldHTML(label, name, val, type = "text", hint = "") {
                const v = val == null ? "" : val;
                if (type === "textarea") return `<div class="field"><label class="field__label">${label}</label><textarea class="input" data-key="${name}" rows="3">${v}</textarea>${hint ? `<p class="field__hint">${hint}</p>` : ""}</div>`;
                return `<div class="field"><label class="field__label">${label}</label><input class="input" type="${type}" data-key="${name}" value="${String(v).replace(/"/g, '&quot;')}">${hint ? `<p class="field__hint">${hint}</p>` : ""}</div>`;
            }
            function imgFieldHTML(label, name, val) {
                const uid = 'upload_' + name.replace(/\./g, '_') + '_' + Math.random().toString(36).slice(2, 7);
                return `<div class="field"><label class="field__label">${label}</label><div class="img-preview-row"><input class="input" data-key="${name}" value="${val || ""}"><img class="img-preview" src="${val || ""}" onerror="this.style.opacity=0.2" onload="this.style.opacity=1"><button type="button" class="img-upload-btn" data-upload-for="${uid}">üìÅ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ</button><input type="file" accept="image/*" id="${uid}" data-target-key="${name}" style="display:none"></div><div class="img-upload-status" id="status_${uid}"></div></div>`;
            }
            function checkboxHTML(label, name, val) {
                return `<div class="checkbox-row"><input type="checkbox" data-key="${name}" ${val ? "checked" : ""}><span>${label}</span></div>`;
            }

            /* Listen for changes */
            function listenChanges(container) {
                container.addEventListener("input", () => markDirty());
                container.addEventListener("change", () => markDirty());
                /* live image preview */
                container.addEventListener("input", e => {
                    if (!e.target.classList.contains("input")) return;
                    const row = e.target.closest(".img-preview-row");
                    if (row) { const img = row.querySelector(".img-preview"); if (img) img.src = e.target.value }
                });
            }

            /* ARRAY helpers */
            function arrayWrap(containerId, items, renderItem, addLabel, addDefault) {
                let html = items.map((item, i) => renderItem(item, i, items.length)).join("");
                html += `<button class="array-add" data-array="${containerId}">+ ${addLabel}</button>`;
                return html;
            }
            function initArrayActions(secEl, arrKey, renderFn) {
                secEl.addEventListener("click", e => {
                    const btn = e.target.closest("[data-arr-action]");
                    if (!btn) return;
                    const action = btn.dataset.arrAction;
                    const idx = parseInt(btn.dataset.idx);
                    const arr = getNestedVal(DATA, arrKey);
                    if (!arr) return;
                    if (action === "del") { if (arr.length <= 1) { toast("–ú–∏–Ω–∏–º—É–º 1 —ç–ª–µ–º–µ–Ω—Ç", "error"); return } arr.splice(idx, 1) }
                    if (action === "up" && idx > 0) { [arr[idx - 1], arr[idx]] = [arr[idx], arr[idx - 1]] }
                    if (action === "down" && idx < arr.length - 1) { [arr[idx], arr[idx + 1]] = [arr[idx + 1], arr[idx]] }
                    markDirty(); renderFn();
                });
            }
            function getNestedVal(obj, path) { return path.split(".").reduce((o, k) => o && o[k], obj) }
            function setNestedVal(obj, path, val) { const keys = path.split("."); const last = keys.pop(); const parent = keys.reduce((o, k) => o[k], obj); parent[last] = val }

            function arrItemHeader(label, idx, len) {
                return `<div class="array-item__header"><span>${label} #${idx + 1}</span><div class="array-item__actions"><button class="btn btn--outline btn--icon" data-arr-action="up" data-idx="${idx}" title="–í–≤–µ—Ä—Ö">‚Üë</button><button class="btn btn--outline btn--icon" data-arr-action="down" data-idx="${idx}" title="–í–Ω–∏–∑">‚Üì</button><button class="btn btn--danger btn--icon" data-arr-action="del" data-idx="${idx}" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button></div></div>`;
            }

            /* =================== IMAGE UPLOAD =================== */
            const UPLOAD_BUCKET = 'lumina-assets';
            /* –ü—Ä–µ—Ñ–∏–∫—Å –ø—É—Ç–∏ ‚Äî –ø—Ä–∏–≤—è–∑–∞–Ω –∫ —ç—Ç–æ–º—É –ø—Ä–æ–µ–∫—Ç—É */
            const UPLOAD_PREFIX = 'lumina-admin-9f3a2c1b';
            const MAX_FILE_SIZE = 5 * 1024 * 1024; // 5 MB

            /**
             * Upload image to Supabase Storage.
             * @param {File} file
             * @returns {Promise<string>} publicUrl
             */
            async function uploadImage(file) {
                if (file.size > MAX_FILE_SIZE) {
                    throw new Error('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 5 MB)');
                }
                const safeName = file.name.replace(/[^a-zA-Z0-9._-]/g, '') || 'image.jpg';
                const filePath = `${UPLOAD_PREFIX}/${Date.now()}_${safeName}`;

                const { error } = await supa.storage
                    .from(UPLOAD_BUCKET)
                    .upload(filePath, file, { upsert: true });

                if (error) {
                    /* –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–∞–≤ */
                    if (error.statusCode === 401 || error.statusCode === 403 ||
                        (error.message && /unauthorized|forbidden|policy/i.test(error.message))) {
                        throw new Error('–ù–µ—Ç –ø—Ä–∞–≤. –ü—Ä–æ–≤–µ—Ä—å RLS policy (INSERT authenticated + prefix).');
                    }
                    throw new Error(error.message || '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏');
                }

                const { data } = supa.storage
                    .from(UPLOAD_BUCKET)
                    .getPublicUrl(filePath);

                return data.publicUrl;
            }

            /**
             * Set a nested DATA key from dot-notation string.
             * E.g. setNestedData('services.0.image', url)
             */
            function setNestedData(keyPath, value) {
                const keys = keyPath.split('.');
                let ref = DATA;
                for (let i = 0; i < keys.length - 1; i++) {
                    const k = isNaN(keys[i]) ? keys[i] : Number(keys[i]);
                    if (ref[k] == null) ref[k] = {};
                    ref = ref[k];
                }
                const lastKey = isNaN(keys[keys.length - 1]) ? keys[keys.length - 1] : Number(keys[keys.length - 1]);
                ref[lastKey] = value;
            }

            /* Delegated event: click "–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ" ‚Üí trigger hidden file input */
            document.addEventListener('click', (e) => {
                const btn = e.target.closest('.img-upload-btn');
                if (!btn) return;
                const fileInputId = btn.dataset.uploadFor;
                const fileInput = document.getElementById(fileInputId);
                if (fileInput) fileInput.click();
            });

            /* Delegated event: file selected ‚Üí upload */
            document.addEventListener('change', async (e) => {
                const fileInput = e.target;
                if (fileInput.type !== 'file' || !fileInput.dataset.targetKey) return;
                const file = fileInput.files[0];
                if (!file) return;

                const targetKey = fileInput.dataset.targetKey;
                const statusEl = document.getElementById('status_' + fileInput.id);
                const row = fileInput.closest('.img-preview-row');
                const textInput = row ? row.querySelector(`[data-key="${targetKey}"]`) : null;
                const preview = row ? row.querySelector('.img-preview') : null;
                const uploadBtn = row ? row.querySelector('.img-upload-btn') : null;

                /* UI: loading state */
                if (statusEl) { statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...'; statusEl.className = 'img-upload-status img-upload-status--loading'; }
                if (uploadBtn) uploadBtn.disabled = true;

                try {
                    const publicUrl = await uploadImage(file);

                    /* Write URL back into text input (source of truth) */
                    if (textInput) {
                        textInput.value = publicUrl;
                        textInput.dispatchEvent(new Event('input', { bubbles: true }));
                    }

                    /* Update preview */
                    if (preview) { preview.src = publicUrl; preview.style.opacity = '1'; }

                    /* Update DATA object so save picks it up */
                    setNestedData(targetKey, publicUrl);
                    markDirty();

                    if (statusEl) { statusEl.textContent = '–ó–∞–≥—Ä—É–∂–µ–Ω–æ ‚úì'; statusEl.className = 'img-upload-status img-upload-status--ok'; }
                    toast('–§–æ—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ', 'success');
                } catch (err) {
                    console.error('[ADMIN UPLOAD]', err);
                    if (statusEl) { statusEl.textContent = err.message; statusEl.className = 'img-upload-status img-upload-status--err'; }
                    toast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
                } finally {
                    if (uploadBtn) uploadBtn.disabled = false;
                    fileInput.value = ''; /* reset so same file can be re-selected */
                }
            });

            /* =================== RENDER SECTIONS =================== */

            function renderBrand() {
                const el = $("#sec-brand");
                el.innerHTML = `<h2 class="admin-section__title">–ë—Ä–µ–Ω–¥ –∏ Hero</h2><p class="admin-section__helper">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –±–ª–æ–∫ Hero</p>
<div class="card">${fieldHTML("–ù–∞–∑–≤–∞–Ω–∏–µ –±—Ä–µ–Ω–¥–∞", "brand", DATA.brand)}${fieldHTML("Hero –∑–∞–≥–æ–ª–æ–≤–æ–∫ (HTML)", "heroTitle", DATA.heroTitle, "textarea", "–ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å &lt;br&gt; –∏ &lt;span&gt;")}${fieldHTML("Hero –ø–æ–¥–∑–∞–≥–æ–ª–æ–≤–æ–∫", "heroSubtitle", DATA.heroSubtitle, "textarea")}${imgFieldHTML("Hero –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", "heroImage", DATA.heroImage)}</div>`;
                listenChanges(el);
            }

            function renderTrust() {
                const el = $("#sec-trust");
                function draw() {
                    el.innerHTML = `<h2 class="admin-section__title">–î–æ–≤–µ—Ä–∏–µ</h2><p class="admin-section__helper">–ë–ª–æ–∫ —Ü–∏—Ñ—Ä –¥–æ–≤–µ—Ä–∏—è</p><div class="card" id="trust-items">${DATA.trustBadges.map((b, i, a) => `<div class="array-item">${arrItemHeader("–ë–µ–π–¥–∂", i, a.length)}${fieldHTML("–ó–Ω–∞—á–µ–Ω–∏–µ", `trustBadges.${i}.value`, b.value)}${fieldHTML("–¢–µ–∫—Å—Ç", `trustBadges.${i}.text`, b.text)}${fieldHTML("–ò–∫–æ–Ω–∫–∞ (–∫–ª—é—á)", `trustBadges.${i}.iconKey`, b.iconKey)}</div>`).join("")}<button class="array-add" onclick="window._addTrust()">+ –î–æ–±–∞–≤–∏—Ç—å –±–µ–π–¥–∂</button></div>`;
                    initArrayActions(el, "trustBadges", draw); listenChanges(el);
                }
                window._addTrust = () => { DATA.trustBadges.push({ iconKey: "star", value: "", text: "" }); markDirty(); draw() };
                draw();
            }

            function renderWhySection() {
                const el = $("#sec-why");
                function draw() {
                    el.innerHTML = `<h2 class="admin-section__title">–ü–æ—á–µ–º—É –º—ã</h2><p class="admin-section__helper">–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –∫–ª–∏–Ω–∏–∫–∏</p><div class="card">${DATA.why.map((w, i, a) => `<div class="array-item">${arrItemHeader("–ü—É–Ω–∫—Ç", i, a.length)}${fieldHTML("–ó–∞–≥–æ–ª–æ–≤–æ–∫", `why.${i}.title`, w.title)}${fieldHTML("–¢–µ–∫—Å—Ç", `why.${i}.text`, w.text, "textarea")}${fieldHTML("–ò–∫–æ–Ω–∫–∞ (–∫–ª—é—á)", `why.${i}.iconKey`, w.iconKey)}</div>`).join("")}<button class="array-add" onclick="window._addWhy()">+ –î–æ–±–∞–≤–∏—Ç—å –ø—É–Ω–∫—Ç</button></div>`;
                    initArrayActions(el, "why", draw); listenChanges(el);
                }
                window._addWhy = () => { DATA.why.push({ iconKey: "heart", title: "", text: "" }); markDirty(); draw() };
                draw();
            }

            function renderServicesSection() {
                const el = $("#sec-services");
                function draw() {
                    el.innerHTML = `<h2 class="admin-section__title">–£—Å–ª—É–≥–∏</h2><p class="admin-section__helper">Bento-—Å–µ—Ç–∫–∞ —É—Å–ª—É–≥</p><div class="card">${DATA.services.map((s, i, a) => `<div class="array-item">${arrItemHeader("–£—Å–ª—É–≥–∞", i, a.length)}${fieldHTML("–ù–∞–∑–≤–∞–Ω–∏–µ", `services.${i}.title`, s.title)}${fieldHTML("–û–ø–∏—Å–∞–Ω–∏–µ", `services.${i}.desc`, s.desc, "textarea")}${fieldHTML("–¶–µ–Ω–∞ –æ—Ç", `services.${i}.priceFrom`, s.priceFrom, "number")}${imgFieldHTML("–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", `services.${i}.image`, s.image)}${checkboxHTML("Featured (–∫—Ä—É–ø–Ω–∞—è –∫–∞—Ä—Ç–æ—á–∫–∞)", `services.${i}.featured`, s.featured)}</div>`).join("")}<button class="array-add" onclick="window._addSvc()">+ –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</button></div>`;
                    initArrayActions(el, "services", draw); listenChanges(el);
                }
                window._addSvc = () => { DATA.services.push({ title: "", desc: "", priceFrom: 0, image: "assets/", featured: false }); markDirty(); draw() };
                draw();
            }

            function renderCasesSection() {
                const el = $("#sec-cases");
                function draw() {
                    el.innerHTML = `<h2 class="admin-section__title">–ö–µ–π—Å—ã –î–æ / –ü–æ—Å–ª–µ</h2><p class="admin-section__helper">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ä–∞–±–æ—Ç</p><div class="card">${DATA.cases.map((c, i, a) => `<div class="array-item">${arrItemHeader("–ö–µ–π—Å", i, a.length)}${fieldHTML("–ó–∞–≥–æ–ª–æ–≤–æ–∫", `cases.${i}.title`, c.title)}${fieldHTML("–û–ø–∏—Å–∞–Ω–∏–µ", `cases.${i}.caption`, c.caption, "textarea")}${fieldHTML("–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", `cases.${i}.duration`, c.duration)}${imgFieldHTML("–§–æ—Ç–æ –î–æ", `cases.${i}.beforeImage`, c.beforeImage)}${imgFieldHTML("–§–æ—Ç–æ –ü–æ—Å–ª–µ", `cases.${i}.afterImage`, c.afterImage)}</div>`).join("")}<button class="array-add" onclick="window._addCase()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–µ–π—Å</button></div>`;
                    initArrayActions(el, "cases", draw); listenChanges(el);
                }
                window._addCase = () => { DATA.cases.push({ title: "", caption: "", beforeImage: "assets/", afterImage: "assets/", duration: "" }); markDirty(); draw() };
                draw();
            }

            function renderDoctorsSection() {
                const el = $("#sec-doctors");
                function draw() {
                    el.innerHTML = `<h2 class="admin-section__title">–í—Ä–∞—á–∏</h2><p class="admin-section__helper">–ö–æ–º–∞–Ω–¥–∞ —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤</p><div class="card">${DATA.doctors.map((d, i, a) => `<div class="array-item">${arrItemHeader("–í—Ä–∞—á", i, a.length)}${fieldHTML("–ò–º—è", `doctors.${i}.name`, d.name)}${fieldHTML("–†–æ–ª—å", `doctors.${i}.role`, d.role)}${fieldHTML("–û–ø—ã—Ç", `doctors.${i}.experience`, d.experience)}${imgFieldHTML("–§–æ—Ç–æ", `doctors.${i}.photo`, d.photo)}${fieldHTML("–ù–∞–≤—ã–∫–∏ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)", `doctors.${i}.skills`, Array.isArray(d.skills) ? d.skills.join(", ") : "")}</div>`).join("")}<button class="array-add" onclick="window._addDoc()">+ –î–æ–±–∞–≤–∏—Ç—å –≤—Ä–∞—á–∞</button></div>`;
                    initArrayActions(el, "doctors", draw); listenChanges(el);
                }
                window._addDoc = () => { DATA.doctors.push({ name: "", role: "", experience: "", badges: [], skills: [], photo: "assets/" }); markDirty(); draw() };
                draw();
            }

            function renderTestimonialsSection() {
                const el = $("#sec-testimonials");
                function draw() {
                    el.innerHTML = `<h2 class="admin-section__title">–û—Ç–∑—ã–≤—ã</h2><p class="admin-section__helper">–û—Ç–∑—ã–≤—ã –ø–∞—Ü–∏–µ–Ω—Ç–æ–≤</p><div class="card">${DATA.testimonials.map((t, i, a) => `<div class="array-item">${arrItemHeader("–û—Ç–∑—ã–≤", i, a.length)}${fieldHTML("–ò–º—è", `testimonials.${i}.name`, t.name)}${fieldHTML("–¢–µ–∫—Å—Ç", `testimonials.${i}.text`, t.text, "textarea")}${fieldHTML("–†–µ–π—Ç–∏–Ω–≥ (1-5)", `testimonials.${i}.rating`, t.rating, "number")}${fieldHTML("–£—Å–ª—É–≥–∞", `testimonials.${i}.service`, t.service)}${fieldHTML("–ò—Å—Ç–æ—á–Ω–∏–∫", `testimonials.${i}.source`, t.source)}</div>`).join("")}<button class="array-add" onclick="window._addTest()">+ –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button></div>`;
                    initArrayActions(el, "testimonials", draw); listenChanges(el);
                }
                window._addTest = () => { DATA.testimonials.push({ name: "", text: "", rating: 5, service: "", source: "" }); markDirty(); draw() };
                draw();
            }

            function renderPricesSection() {
                const el = $("#sec-prices");
                function draw() {
                    el.innerHTML = `<h2 class="admin-section__title">–¶–µ–Ω—ã</h2><p class="admin-section__helper">–ü—Ä–µ–π—Å–∫—É—Ä–∞–Ω—Ç</p><div class="card">${DATA.prices.map((p, i, a) => `<div class="array-item">${arrItemHeader("–ü–æ–∑–∏—Ü–∏—è", i, a.length)}${fieldHTML("–ù–∞–∑–≤–∞–Ω–∏–µ", `prices.${i}.name`, p.name)}${fieldHTML("–¶–µ–Ω–∞ –æ—Ç", `prices.${i}.priceFrom`, p.priceFrom, "number")}${fieldHTML("–ó–∞–º–µ—Ç–∫–∞", `prices.${i}.note`, p.note || "")}${checkboxHTML("–ê–∫—Ü–µ–Ω—Ç (–≤—ã–¥–µ–ª–∏—Ç—å)", `prices.${i}.accent`, p.accent)}</div>`).join("")}<button class="array-add" onclick="window._addPrice()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button></div>`;
                    initArrayActions(el, "prices", draw); listenChanges(el);
                }
                window._addPrice = () => { DATA.prices.push({ name: "", priceFrom: 0, note: null, accent: false }); markDirty(); draw() };
                draw();
            }

            function renderQuizSection() {
                const el = $("#sec-quiz");
                function draw() {
                    // === FIX: triple-guard quiz and quiz.steps ===
                    if (!DATA.quiz || typeof DATA.quiz !== 'object' || Array.isArray(DATA.quiz)) DATA.quiz = { steps: [], finalBonusText: "" };
                    if (!Array.isArray(DATA.quiz.steps)) DATA.quiz.steps = [];
                    const quiz = DATA.quiz;
                    el.innerHTML = `<h2 class="admin-section__title">–ö–≤–∏–∑</h2><p class="admin-section__helper">–ü–æ–¥–±–æ—Ä –ª–µ—á–µ–Ω–∏—è</p>
<div class="card">${fieldHTML("–¢–µ–∫—Å—Ç —Ñ–∏–Ω–∞–ª–∞", "quiz.finalBonusText", quiz.finalBonusText || "", "textarea")}</div>
<div class="card">${quiz.steps.map((s, i, a) => `<div class="array-item">${arrItemHeader("–®–∞–≥", i, a.length)}${fieldHTML("–í–æ–ø—Ä–æ—Å", `quiz.steps.${i}.question`, s.question)}${fieldHTML("–í–∞—Ä–∏–∞–Ω—Ç—ã (–∫–∞–∂–¥—ã–π —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏)", `quiz.steps.${i}.options`, Array.isArray(s.options) ? s.options.join("\n") : "", "textarea")}</div>`).join("")}<button class="array-add" onclick="window._addStep()">+ –î–æ–±–∞–≤–∏—Ç—å —à–∞–≥</button></div>`;
                    initArrayActions(el, "quiz.steps", draw); listenChanges(el);
                }
                window._addStep = () => { if (!DATA.quiz) DATA.quiz = { steps: [], finalBonusText: "" }; if (!Array.isArray(DATA.quiz.steps)) DATA.quiz.steps = []; DATA.quiz.steps.push({ question: "", options: [""] }); markDirty(); draw() };
                draw();
            }

            function renderContactsSection() {
                const el = $("#sec-contacts");
                const c = DATA.contacts || {};
                el.innerHTML = `<h2 class="admin-section__title">–ö–æ–Ω—Ç–∞–∫—Ç—ã</h2><p class="admin-section__helper">–ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</p>
<div class="card">
${fieldHTML("–¢–µ–ª–µ—Ñ–æ–Ω (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)", "contacts.phone", c.phone)}
${fieldHTML("–¢–µ–ª–µ—Ñ–æ–Ω (raw –¥–ª—è —Å—Å—ã–ª–∫–∏)", "contacts.phoneRaw", c.phoneRaw)}
${fieldHTML("–¢–µ–ª–µ—Ñ–æ–Ω 2 (–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ)", "contacts.phoneSecondary", c.phoneSecondary || "")}
${fieldHTML("–¢–µ–ª–µ—Ñ–æ–Ω 2 (raw)", "contacts.phoneSecondaryRaw", c.phoneSecondaryRaw || "")}
${fieldHTML("WhatsApp (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)", "contacts.whatsappDigits", c.whatsappDigits || c.whatsapp)}
${fieldHTML("E-mail", "contacts.email", c.email, "email")}
${fieldHTML("–ê–¥—Ä–µ—Å", "contacts.address", c.address)}
${fieldHTML("–ê–¥—Ä–µ—Å —Ñ–∏–ª–∏–∞–ª–∞ 2", "contacts.addressSecondary", c.addressSecondary || "", "text", "–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ —Ñ–∏–ª–∏–∞–ª–∞ –Ω–µ—Ç")}
${fieldHTML("–†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã", "contacts.hours", c.hours)}
${fieldHTML("Google Maps Embed URL", "contacts.mapEmbedUrl", c.mapEmbedUrl, "textarea")}
</div>`;
                listenChanges(el);
            }

            /* =================== COLLECT DATA FROM FORMS =================== */
            function collectData() {
                const obj = deepClone(DATA);
                $$("[data-key]").forEach(inp => {
                    const key = inp.dataset.key;
                    let val;
                    if (inp.type === "checkbox") val = inp.checked;
                    else if (inp.type === "number") val = parseFloat(inp.value) || 0;
                    else val = inp.value;
                    /* handle nested keys */
                    const keys = key.split(".");
                    let ref = obj;
                    for (let i = 0; i < keys.length - 1; i++) {
                        const k = keys[i];
                        const next = keys[i + 1];
                        if (!isNaN(next)) { if (!Array.isArray(ref[k])) ref[k] = []; ref = ref[k] }
                        else { if (!ref[k]) ref[k] = {}; ref = ref[k] }
                    }
                    const lastKey = keys[keys.length - 1];
                    /* parse arrays in textareas (skills, options) */
                    if (lastKey === "skills" && typeof val === "string") { ref[lastKey] = val.split(",").map(s => s.trim()).filter(Boolean) }
                    else if (lastKey === "options" && typeof val === "string") { ref[lastKey] = val.split("\n").map(s => s.trim()).filter(Boolean) }
                    else { ref[lastKey] = val }
                });
                /* Keep whatsapp field in sync */
                if (obj.contacts) { obj.contacts.whatsapp = obj.contacts.whatsappDigits || obj.contacts.whatsapp }
                return obj;
            }

            /* VALIDATE */
            function validate(obj) {
                const errors = [];
                if (!obj.heroTitle) errors.push("Hero –∑–∞–≥–æ–ª–æ–≤–æ–∫ –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
                if (!obj.contacts?.phone) errors.push("–¢–µ–ª–µ—Ñ–æ–Ω –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
                if (!obj.contacts?.whatsappDigits) errors.push("WhatsApp digits –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω");
                if (obj.services) { obj.services.forEach((s, i) => { if (s.priceFrom < 0) errors.push(`–£—Å–ª—É–≥–∞ #${i + 1}: —Ü–µ–Ω–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–æ–π`) }) }
                if (obj.prices) { obj.prices.forEach((p, i) => { if (p.priceFrom < 0) errors.push(`–¶–µ–Ω–∞ #${i + 1}: –∑–Ω–∞—á–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–º`) }) }
                return errors;
            }

            /* =================== ACTIONS =================== */
            function initActions() {
                /* SAVE */
                $("#btn-save").onclick = async () => {
                    const obj = collectData();
                    const errs = validate(obj);
                    if (errs.length) { toast(errs[0], "error"); return }
                    $("#btn-save").disabled = true; $("#btn-save").textContent = "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...";
                    try {
                        const { error } = await supa.from("site_settings").update({ data: obj, updated_at: new Date().toISOString() }).eq("id", "lumina");
                        if (error) throw error;
                        localStorage.setItem(LS_KEY, JSON.stringify(obj));
                        localStorage.setItem(LS_UPD, Date.now().toString());
                        DATA = obj; setStatus(true); toast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –æ–±–ª–∞–∫–µ ‚úì");
                    } catch (e) { toast("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: " + e.message, "error") }
                    $("#btn-save").disabled = false; $("#btn-save").textContent = "üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å";
                };

                /* EXPORT */
                $("#btn-export").onclick = () => {
                    const obj = collectData();
                    const str = "const DEFAULT_SITE_DATA = " + JSON.stringify(obj, null, 2) + ";\n\nfunction getSiteData(){try{const s=localStorage.getItem('siteData_lumina');if(s)return Object.assign({},DEFAULT_SITE_DATA,JSON.parse(s))}catch(e){}return DEFAULT_SITE_DATA}\nwindow.SITE_DATA=getSiteData();\n";
                    const blob = new Blob([str], { type: "application/javascript" });
                    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "data.js"; a.click(); URL.revokeObjectURL(a.href);
                    toast("data.js —Å–∫–∞—á–∞–Ω", "info");
                };

                /* PREVIEW */
                $("#btn-preview").onclick = () => window.open("index.html", "_blank");

                /* RESET */
                $("#btn-reset").onclick = async () => {
                    if (!confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∫ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é? –≠—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –æ–±–ª–∞–∫–µ.")) return;
                    const def = deepClone(window.DEFAULT_SITE_DATA || {});
                    try {
                        await supa.from("site_settings").update({ data: def, updated_at: new Date().toISOString() }).eq("id", "lumina");
                        localStorage.setItem(LS_KEY, JSON.stringify(def));
                        localStorage.setItem(LS_UPD, Date.now().toString());
                    } catch (e) { console.warn(e) }
                    DATA = def; buildSections(); switchSection(SECTIONS[0].id); setStatus(true); toast("–î–∞–Ω–Ω—ã–µ —Å–±—Ä–æ—à–µ–Ω—ã –∫ –¥–µ—Ñ–æ–ª—Ç—É");
                };

                /* LOGOUT */
                $("#btn-logout").onclick = async () => {
                    await supa.auth.signOut();
                    location.reload();
                };
            }

            /* =================== INIT =================== */
            function startAdmin() {
                console.log("[ADMIN] startAdmin() ‚Äî DOM ready");
                console.log("[ADMIN] data.js loaded?", typeof DEFAULT_SITE_DATA !== "undefined");
                console.log("[ADMIN] supabase loaded?", typeof window.supabase !== "undefined");
                initAuth();
            }
            if (document.readyState === "loading") {
                document.addEventListener("DOMContentLoaded", startAdmin);
            } else {
                startAdmin();
            }

        })();
    </script>
</body>

</html>